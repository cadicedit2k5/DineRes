{% extends "admin/base_site.html" %}
{% load humanize %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<script src="https://kit.fontawesome.com/f693779e37.js" crossorigin="anonymous"></script>
{% endblock %}

{% block title %}Thống kê{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="text-success mb-0">
        <i class="bi bi-credit-card-2-front"></i> Báo cáo
    </h2>
</div>

<ul class="object-tools">
  <li><a href="?period=day" class="button">Theo ngày</a></li>
  <li><a href="?period=week" class="button">Theo tuần</a></li>
  <li><a href="?period=month" class="button">Theo tháng</a></li>
</ul>


<div class="row mt-4 g-3">
    <div class="col-md-3">
        <div class="card dashboard-card shadow-sm border-0 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted text-uppercase">Doanh thu {{ period_label }}</small>
                    <h4 class="text-success fw-bold">
                        {{ total_amount_stat|intcomma }} đ
                    </h4>
                </div>
                <i class="bi bi-cash text-success fs-1"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card dashboard-card shadow-sm border-0 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted text-uppercase">Số món bán trong {{ period_label }}</small>
                    <h4 class="text-primary fw-bold">
                        {{ total_quantity_timeline.total_quantity }} món
                    </h4>
                </div>
                <i class="bi bi-bag-dash text-primary fs-1"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card dashboard-card shadow-sm border-0 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted text-uppercase">Số bàn đặt trong {{ period_label }}</small>
                    <h4 class="text-warning fw-bold">
                        {{ booking_amount }} bàn
                    </h4>
                </div>
                <i class="bi bi-clipboard-check text-warning fs-1"></i>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card dashboard-card shadow-sm border-0 h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted text-uppercase">Số lượng món</small>
                    <h4 class="text-info fw-bold">
                        {{ dishes_quantity }} món
                    </h4>
                </div>
                <i class="fa-solid fa-utensils text-info fs-1"></i>
            </div>
        </div>
    </div>
</div>

<h1 class="text-center text-success mt-5">
    <i class="bi bi-bar-chart-line"></i>
    Thống kê
</h1>

<div class="row mt-4 g-4">
    <div class="col-md-4 col-12">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-light fw-bold">
                Chi tiết món bán
            </div>

            <div class="table-wrapper">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Món</th>
                            <th>SL</th>
                            <th>Doanh thu</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in total_quantity_stats %}
                        <tr>
                            <td>{{ d.dish__id }}</td>
                            <td>{{ d.dish__name }}</td>
                            <td class="fw-bold text-center">{{ d.total_quantity }}</td>
                            <td class="text-success text-end">
                                {{ d.total_amount|intcomma }} đ
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-8 col-12">
        <div class="card shadow-sm border-0 p-3 h-100">
            <h6 class="fw-bold text-center mb-2">
                Số lượng bán theo món
            </h6>
            <canvas id="myChart2"></canvas>
        </div>
    </div>

    <div class="col-md-12 col-12">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="fw-bold text-center mb-2">
                Doanh thu theo món
            </h6>
            <canvas id="myChart1"></canvas>
        </div>
    </div>
</div>

<div class="row mt-4 g-4">
    <div class="col-md-4 col-12">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-light fw-bold">
                Tần suất đặt bàn
            </div>

            <div class="table-wrapper">
                <table class="table table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Số lượng đặt bàn</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in total_booking_timeline %}
                        <tr>
                            <td>{{ d.time }}</td>
                            <td>{{ d.total_bookings }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-8 col-12">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="fw-bold text-center mb-2">
                Tần suất đặt bàn
            </h6>
            <canvas id="myChart3"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function drawChart(ctx, labels, data, typeChart, labelText) {
        new Chart(ctx, {
            type: typeChart,
            data: {
              labels: labels,
              datasets: [{
                label: labelText,
                data: data,
                backgroundColor: [
                   'rgba(75, 192, 192, 0.7)',
                   'rgba(54, 162, 235, 0.7)',
                   'rgba(255, 99, 132, 0.7)',
                   'rgba(255, 206, 86, 0.7)',
                   'rgba(153, 102, 255, 0.7)',
                   'rgba(255, 159, 64, 0.7)'
                ],
                borderRadius: 8,
                borderSkipped: false
              }]
            },
            options: {
            animation: {
                duration: 1200,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#212529',
                    padding: 10
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { drawBorder: false }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
          });
    }

    window.onload = function() {
        labels1 = []
        data1 = []

        {% for d in total_quantity_stats %}
            labels1.push('{{ d.dish__name }}')
            data1.push({{ d.total_amount }})
        {% endfor %}

        const ctx1 = document.getElementById('myChart1');
        drawChart(ctx1, labels1, data1, 'line', 'Doanh thu món ăn')


        labels2 = []
        data2 = []

        {% for d in total_quantity_stats %}
            labels2.push('{{ d.dish__name }}')
            data2.push({{ d.total_quantity }})
        {% endfor %}

        const ctx2 = document.getElementById('myChart2');
        drawChart(ctx2, labels2, data2, 'bar', 'Số lượng món ăn')

        labels3 = []
        data3 = []

        {% for d in total_booking_timeline %}
            labels3.push('{{ d.week|date:"W/Y" }}')
            data3.push({{ d.total_bookings }})
        {% endfor %}

        const ctx3 = document.getElementById('myChart3');
        drawChart(ctx3, labels3, data3, 'bar', 'Tần suất đặt bàn')

    }
</script>

<style>
.dashboard-card {
    border-radius: 18px;
    transition: all 0.2s ease;
}

.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 25px rgba(0,0,0,.08);
}

.dashboard-card i {
    opacity: 0.25;
}

.kpi-icon {
    font-size: 2.5rem;
    opacity: 0.25;
}

.table-wrapper {
    max-height: 420px;
    overflow-y: auto;
    border-radius: 12px;
}

.table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 1;
}

canvas {
    max-height: 420px;
}
</style>

{% endblock %}

